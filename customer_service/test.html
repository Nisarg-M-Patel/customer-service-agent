<!DOCTYPE html>
<html>
<head>
    <title>Customer Service API Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 50px auto; }
        button { padding: 10px 20px; margin: 10px; }
        input { padding: 10px; margin: 10px; width: 400px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .ready { background: #d4edda; }
        .not-ready { background: #f8d7da; }
        .section { border: 2px solid #007bff; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .debug-section { border-color: #17a2b8; }
        .vector-section { border-color: #6f42c1; }
        .results-section { border-color: #28a745; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .expandable { cursor: pointer; background: #e9ecef; padding: 5px; margin: 5px 0; border-radius: 3px; }
        .content-box { border-left: 3px solid #007bff; padding-left: 10px; margin: 10px 0; }
        .intent-box { border-left-color: #28a745; }
        .es-box { border-left-color: #ffc107; }
        .vector-box { border-left-color: #6f42c1; }
        .results-box { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>Customer Service API Comprehensive Test</h1>
    
    <div class="section">
        <h3>üè• Basic Health Checks</h3>
        <button onclick="checkHealth()">Check Health</button>
        <button onclick="checkReady()">Check Ready</button>
        <button onclick="forceInit()">Force Initialize</button>
    </div>
    
    <div class="section debug-section">
        <h3>üîç Comprehensive Debug</h3>
        <p>This will test the entire search pipeline: Intent Analysis ‚Üí Elasticsearch ‚Üí Final Results</p>
        <input type="text" id="comprehensiveQuery" placeholder="Enter search query..." value="My plants are sitting in water and won't drain">
        <button onclick="comprehensiveDebug()">üöÄ Full Pipeline Debug</button>
    </div>
    
    <div class="section vector-section">
        <h3>üî¨ Vector Search Testing</h3>
        <p>Test the new vector-based semantic search functionality</p>
        <input type="text" id="vectorQuery" placeholder="Enter search query..." value="my plants have yellow leaves and are dying">
        <button onclick="testVectorSearch()">üöÄ Test Vector Search</button>
    </div>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8001';
        
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                showSimpleResult('Health Check', data, response.ok);
            } catch (error) {
                showSimpleResult('Health Check', {error: error.message}, false);
            }
        }
        
        async function checkReady() {
            try {
                const response = await fetch(`${API_BASE}/api/ready`);
                const data = await response.json();
                showSimpleResult('Ready Check', data, response.ok);
                
                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${data.ready ? 'ready' : 'not-ready'}`;
                statusDiv.innerHTML = data.ready ? 
                    `‚úÖ Agent Ready! Found ${data.product_count} products` : 
                    `‚ùå Agent Not Ready: ${data.reason}`;
                document.getElementById('results').appendChild(statusDiv);
                
            } catch (error) {
                showSimpleResult('Ready Check', {error: error.message}, false);
            }
        }
        
        async function forceInit() {
            try {
                showSimpleResult('Initializing...', {message: 'Starting initialization...'}, true);
                
                const response = await fetch(`${API_BASE}/api/initialize`, {
                    method: 'POST'
                });
                const data = await response.json();
                showSimpleResult('Force Initialize', data, response.ok);
                
            } catch (error) {
                showSimpleResult('Force Initialize', {error: error.message}, false);
            }
        }
        
        async function comprehensiveDebug() {
            const query = document.getElementById('comprehensiveQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                showSimpleResult('üöÄ Comprehensive Debug', {message: `Running full pipeline for: "${query}"`}, true);
                
                const response = await fetch(`${API_BASE}/api/debug-comprehensive/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                showComprehensiveResult('Comprehensive Debug Results', data, response.ok);
                
            } catch (error) {
                showSimpleResult('Comprehensive Debug', {error: error.message}, false);
            }
        }
        
        async function testVectorSearch() {
            const query = document.getElementById('vectorQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                showSimpleResult('üî¨ Vector Search Test', {message: `Testing vector search for: "${query}"`}, true);
                
                const response = await fetch(`${API_BASE}/api/test-vector-search/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                showVectorSearchResult('Vector Search Test Results', data, response.ok);
                
            } catch (error) {
                showSimpleResult('Vector Search Test', {error: error.message}, false);
            }
        }
        
        function showSimpleResult(title, data, success) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `
                <h3>${title} ${success ? '‚úÖ' : '‚ùå'}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }
        
        function showVectorSearchResult(title, data, success) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'results-section section';
            
            let html = `<h2>${title} ${success ? '‚úÖ' : '‚ùå'}</h2>`;
            
            if (data.error) {
                html += `<div class="error">‚ùå Error: ${data.error}</div>`;
            } else {
                // Comparison summary
                if (data.comparison) {
                    const comp = data.comparison;
                    html += `<div class="content-box">`;
                    html += `<h4>üìä Search Comparison</h4>`;
                    html += `<div>Vector Search: ${comp.vector_count} results</div>`;
                    html += `<div>Keyword Search: ${comp.keyword_count} results</div>`;
                    html += `<div class="${comp.vector_better ? 'success' : 'warning'}">Vector search ${comp.vector_better ? 'performed better' : 'performed similarly'}</div>`;
                    html += `</div>`;
                }
                
                // Vector search results
                if (data.vector_search_results && data.vector_search_results.length > 0) {
                    html += `<div class="content-box vector-box">`;
                    html += `<h4>ü§ñ Vector Search Results (${data.vector_search_results.length})</h4>`;
                    data.vector_search_results.forEach((result, i) => {
                        html += `<div style="margin-left: 20px; border-left: 3px solid #6f42c1; padding-left: 10px; margin-bottom: 10px;">`;
                        html += `<div><strong>${i+1}. ${result.product_title}</strong> (${result.confidence.toFixed(3)})</div>`;
                        html += `<div>ID: ${result.product_id} | Price: $${result.price}</div>`;
                        html += `<div>Reasons: ${result.reasons.join(', ')}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="content-box vector-box"><h4>ü§ñ Vector Search Results</h4><div class="error">No vector search results</div></div>`;
                }
                
                // Keyword search results
                if (data.keyword_search_results && data.keyword_search_results.length > 0) {
                    html += `<div class="content-box es-box">`;
                    html += `<h4>üî§ Keyword Search Results (${data.keyword_search_results.length})</h4>`;
                    data.keyword_search_results.forEach((result, i) => {
                        html += `<div style="margin-left: 20px; border-left: 3px solid #ffc107; padding-left: 10px; margin-bottom: 10px;">`;
                        html += `<div><strong>${i+1}. ${result.product_title}</strong> (${result.confidence.toFixed(3)})</div>`;
                        html += `<div>ID: ${result.product_id} | Price: $${result.price}</div>`;
                        html += `<div>Reasons: ${result.reasons.join(', ')}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="content-box es-box"><h4>üî§ Keyword Search Results</h4><div class="error">No keyword search results</div></div>`;
                }
            }
            
            // Raw data
            html += `<details style="margin-top: 20px;"><summary>üìã Raw Vector Test Data</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
            
            div.innerHTML = html;
            results.appendChild(div);
        }
        
        function showComprehensiveResult(title, data, success) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'results-section section';
            
            let html = `<h2>${title} ${success ? '‚úÖ' : '‚ùå'}</h2>`;
            
            // Show errors first if any
            if (data.errors && data.errors.length > 0) {
                html += `<div class="error">‚ö†Ô∏è Errors Found:</div>`;
                data.errors.forEach(error => {
                    html += `<div class="error">‚Ä¢ ${error}</div>`;
                });
            }
            
            // Integration Status
            if (data.integration_status) {
                const status = data.integration_status;
                html += `<div class="content-box">`;
                html += `<h4>üîß Integration Status</h4>`;
                html += `<div>Providers: ${status.providers.join(', ')}</div>`;
                html += `<div>Search Provider: ${status.has_search_provider ? '‚úÖ ' + status.search_provider_type : '‚ùå None'}</div>`;
                html += `<div>Config: ${status.config_search_provider}</div>`;
                html += `<div>ES Version: ${status.es_version_support || 'Unknown'}</div>`;
                html += `</div>`;
            }
            
            // Vector Search Debug
            if (data.vector_search_debug) {
                const vector = data.vector_search_debug;
                html += `<div class="content-box vector-box">`;
                html += `<h4>üî¨ Vector Search Debug</h4>`;
                html += `<div>Embeddings Available: ${vector.embeddings_available ? '‚úÖ Yes' : '‚ùå No'}</div>`;
                
                if (vector.embeddings_available) {
                    html += `<div>Model: ${vector.embedding_model || 'Unknown'}</div>`;
                    html += `<div>Embedding Dimension: ${vector.test_embedding_dimension}</div>`;
                    html += `<div>Test Embedding: ${vector.test_embedding_success ? '‚úÖ Success' : '‚ùå Failed'}</div>`;
                    
                    if (vector.sample_product_vectors) {
                        const spv = vector.sample_product_vectors;
                        html += `<div><strong>Sample Product Vectors:</strong></div>`;
                        html += `<div style="margin-left: 20px;">Title Vector: ${spv.has_title_vector ? '‚úÖ' : '‚ùå'}</div>`;
                        html += `<div style="margin-left: 20px;">Description Vector: ${spv.has_description_vector ? '‚úÖ' : '‚ùå'}</div>`;
                        html += `<div style="margin-left: 20px;">Usage Scenarios Vectors: ${spv.has_usage_scenarios_vectors ? '‚úÖ (' + spv.usage_scenarios_vector_count + ')' : '‚ùå'}</div>`;
                    }
                } else {
                    html += `<div class="error">Reason: ${vector.reason || vector.error || 'Unknown'}</div>`;
                }
                html += `</div>`;
            }
            
            // Intent Analysis
            if (data.intent_analysis && data.intent_analysis.detected_intent) {
                const intent = data.intent_analysis;
                html += `<div class="content-box intent-box">`;
                html += `<h4>üß† Intent Analysis</h4>`;
                html += `<div><strong>Primary Problem:</strong> ${intent.detected_intent.primary_problem}</div>`;
                html += `<div><strong>Context:</strong> ${intent.detected_intent.context.join(', ')}</div>`;
                html += `<div><strong>Symptoms:</strong> ${intent.detected_intent.symptoms.join(', ')}</div>`;
                
                if (intent.problem_variations && intent.problem_variations.length > 0) {
                    html += `<div><strong>Problem Variations (${intent.problem_variations.length}):</strong></div>`;
                    intent.problem_variations.forEach((variation, i) => {
                        html += `<div style="margin-left: 20px;">${i+1}. ${variation.problem} (${variation.confidence})</div>`;
                    });
                }
                html += `</div>`;
            }
            
            // Elasticsearch Debug
            if (data.elasticsearch_debug) {
                const es = data.elasticsearch_debug;
                html += `<div class="content-box es-box">`;
                html += `<h4>üîç Elasticsearch Debug</h4>`;
                html += `<div><strong>Index:</strong> ${es.index_name}</div>`;
                html += `<div><strong>Total Fields:</strong> ${es.total_fields}</div>`;
                html += `<div><strong>Vector Support:</strong> ${es.has_vector_support ? '‚úÖ Yes' : '‚ùå No'}</div>`;
                
                if (es.vector_fields_in_mapping && Object.keys(es.vector_fields_in_mapping).length > 0) {
                    html += `<div><strong>Vector Fields:</strong></div>`;
                    Object.entries(es.vector_fields_in_mapping).forEach(([field, config]) => {
                        html += `<div style="margin-left: 20px;">${field}: ${config.dims}D (${config.similarity})</div>`;
                    });
                }
                html += `</div>`;
            }
            
            // Search Results Comparison
            if (data.search_results) {
                const results = data.search_results;
                html += `<div class="content-box results-box">`;
                html += `<h4>üéØ Search Results Comparison</h4>`;
                
                // Vector Intent Results
                if (results.vector_intent_results && results.vector_intent_results.length > 0) {
                    html += `<div class="success">ü§ñ Vector Intent Search: ${results.vector_intent_results.length} results</div>`;
                    results.vector_intent_results.forEach((result, i) => {
                        html += `<div style="margin-left: 20px;">${i+1}. ${result.product_title} (${result.confidence.toFixed(3)})</div>`;
                    });
                } else {
                    html += `<div class="error">ü§ñ Vector Intent Search: 0 results</div>`;
                }
                
                // Original Intent Results
                if (results.intent_results && results.intent_results.length > 0) {
                    html += `<div class="success">üî§ Original Intent Search: ${results.intent_results.length} results</div>`;
                } else {
                    html += `<div class="error">üî§ Original Intent Search: 0 results</div>`;
                }
                
                // Keyword Results
                if (results.keyword_results && results.keyword_results.length > 0) {
                    html += `<div class="success">üìù Keyword Search: ${results.keyword_results.length} results</div>`;
                } else {
                    html += `<div class="error">üìù Keyword Search: 0 results</div>`;
                }
                html += `</div>`;
            }
            
            // Raw data
            html += `<details style="margin-top: 20px;"><summary>üìã Raw Debug Data</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
            
            div.innerHTML = html;
            results.appendChild(div);
        }
        
        // Auto-check health on load
        checkHealth();
    </script>
</body>
</html>